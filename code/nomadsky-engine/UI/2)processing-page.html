<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VM Migration Status</title>
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #1e3a5f, #2d5a7b, #3d7a9c);
        color: #ffffff;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
    }
    
    .container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        padding: 40px;
        max-width: 700px;
        width: 100%;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        margin-top: 30px;
    }
    
    h1 {
        color: #2c3e50;
        font-size: 2em;
        font-weight: 300;
        margin: 0 0 10px 0;
        text-align: center;
    }
    
    .vm-info {
        text-align: center;
        color: #5a6c7d;
        font-size: 0.95em;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e0e0e0;
    }
    
    .vm-info strong {
        color: #2d5a7b;
    }
    
    .status-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .status-item {
        display: flex;
        align-items: center;
        padding: 18px 20px;
        margin-bottom: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #e0e0e0;
        transition: all 0.3s ease;
    }
    
    .status-item.pending {
        border-left-color: #95a5a6;
        opacity: 0.6;
    }
    
    .status-item.running {
        border-left-color: #3498db;
        background: #e3f2fd;
        animation: pulse 2s infinite;
    }
    
    .status-item.completed {
        border-left-color: #27ae60;
        background: #e8f5e9;
    }
    
    .status-item.error {
        border-left-color: #e74c3c;
        background: #ffebee;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
    }
    
    .status-icon {
        width: 32px;
        height: 32px;
        margin-right: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .status-content {
        flex: 1;
    }
    
    .status-title {
        font-weight: 600;
        color: #2c3e50;
        font-size: 1em;
        margin-bottom: 3px;
    }
    
    .status-description {
        font-size: 0.85em;
        color: #7f8c8d;
    }
    
    .error-details {
        margin-top: 8px;
        padding: 10px;
        background: rgba(231, 76, 60, 0.1);
        border-radius: 4px;
        font-size: 0.85em;
        color: #c0392b;
    }
    
    .vm-list {
        margin-top: 8px;
        padding: 10px;
        background: rgba(52, 152, 219, 0.1);
        border-radius: 4px;
        font-size: 0.85em;
        color: #2980b9;
    }
    
    .vm-list-title {
        font-weight: 600;
        margin-bottom: 5px;
    }
    
    .vm-list ul {
        margin: 5px 0;
        padding-left: 20px;
    }
    
    .success-banner {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
        color: white;
        padding: 25px;
        border-radius: 8px;
        text-align: center;
        margin-top: 20px;
        display: none;
    }
    
    .success-banner.show {
        display: block;
        animation: slideIn 0.5s ease;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .success-banner h2 {
        margin: 0 0 10px 0;
        font-size: 1.5em;
    }
    
    .success-banner p {
        margin: 0;
        font-size: 1em;
        opacity: 0.95;
    }
    
    /* Spinner animation */
    .spinner {
        border: 3px solid rgba(52, 152, 219, 0.3);
        border-top: 3px solid #3498db;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .checkmark {
        color: #27ae60;
        font-size: 24px;
    }
    
    .error-icon {
        color: #e74c3c;
        font-size: 24px;
    }
    
    .pending-icon {
        color: #95a5a6;
        font-size: 24px;
    }
    
    @media (max-width: 600px) {
        .container {
            padding: 25px 20px;
        }
        
        h1 {
            font-size: 1.5em;
        }
        
        .status-item {
            padding: 15px;
        }
    }
</style>
</head>
<body>
<div class="container">
    <h1>VM Migration in Progress</h1>
    <div class="vm-info">
        <strong>Source:</strong> <span id="source-platform">Azure</span> → 
        <strong>Destination:</strong> <span id="dest-platform">AWS</span><br>
        <strong>VM Name:</strong> <span id="vm-name">production-server-01</span>
    </div>
    
    <ul class="status-list">
        <li class="status-item" id="step1">
            <div class="status-icon">
                <span class="pending-icon">○</span>
            </div>
            <div class="status-content">
                <div class="status-title">1. Fetching VM</div>
                <div class="status-description">Searching for VM in source platform...</div>
            </div>
        </li>
        
        <li class="status-item pending" id="step2">
            <div class="status-icon">
                <span class="pending-icon">○</span>
            </div>
            <div class="status-content">
                <div class="status-title">2. Stopping VM</div>
                <div class="status-description">Gracefully shutting down the virtual machine...</div>
            </div>
        </li>
        
        <li class="status-item pending" id="step3">
            <div class="status-icon">
                <span class="pending-icon">○</span>
            </div>
            <div class="status-content">
                <div class="status-title">3. Downloading VM</div>
                <div class="status-description">Downloading OS disk image from source...</div>
            </div>
        </li>
        
        <li class="status-item pending" id="step4">
            <div class="status-icon">
                <span class="pending-icon">○</span>
            </div>
            <div class="status-content">
                <div class="status-title">4. Transforming OS File Format</div>
                <div class="status-description">Converting disk image to destination format...</div>
            </div>
        </li>
        
        <li class="status-item pending" id="step5">
            <div class="status-icon">
                <span class="pending-icon">○</span>
            </div>
            <div class="status-content">
                <div class="status-title">5. Creating Networking Resources</div>
                <div class="status-description">Setting up VNet, subnet, and security groups...</div>
            </div>
        </li>
        
        <li class="status-item pending" id="step6">
            <div class="status-icon">
                <span class="pending-icon">○</span>
            </div>
            <div class="status-content">
                <div class="status-title">6. Uploading Image</div>
                <div class="status-description">Uploading converted image to destination platform...</div>
            </div>
        </li>
        
        <li class="status-item pending" id="step7">
            <div class="status-icon">
                <span class="pending-icon">○</span>
            </div>
            <div class="status-content">
                <div class="status-title">7. Starting VM</div>
                <div class="status-description">Provisioning and booting the virtual machine...</div>
            </div>
        </li>
    </ul>
    
    <div class="success-banner" id="success-banner">
        <h2>✓ Migration Completed Successfully!</h2>
        <p>VM is now running on <span id="final-platform">AWS</span></p>
    </div>
</div>

<script>
// Get form values and display them
const source = '{{source}}';
const destination = '{{destination}}';
const vmname = '{{vmname}}';

document.getElementById('source-platform').textContent = source;
document.getElementById('dest-platform').textContent = destination;
document.getElementById('vm-name').textContent = vmname;

// Update step status
function updateStep(stepId, status, customMessage = null, extraData = null) {
    const step = document.getElementById(stepId);
    const icon = step.querySelector('.status-icon');
    const description = step.querySelector('.status-description');
    
    step.classList.remove('pending', 'running', 'completed', 'error');
    step.classList.add(status);
    
    if (status === 'running') {
        icon.innerHTML = '<div class="spinner"></div>';
    } else if (status === 'completed') {
        icon.innerHTML = '<span class="checkmark">✓</span>';
    } else if (status === 'error') {
        icon.innerHTML = '<span class="error-icon">✗</span>';
    } else {
        icon.innerHTML = '<span class="pending-icon">○</span>';
    }
    
    if (customMessage) {
        description.textContent = customMessage;
    }
    
    if (extraData) {
        const existingExtra = step.querySelector('.error-details, .vm-list');
        if (existingExtra) existingExtra.remove();
        
        const extraDiv = document.createElement('div');
        extraDiv.className = extraData.type === 'error' ? 'error-details' : 'vm-list';
        
        if (extraData.type === 'error') {
            extraDiv.textContent = extraData.message;
        } else if (extraData.type === 'vm-list') {
            extraDiv.innerHTML = `
                <div class="vm-list-title">Available VMs found:</div>
                <ul>${extraData.vms.map(vm => `<li>${vm}</li>`).join('')}</ul>
            `;
        }
        
        step.querySelector('.status-content').appendChild(extraDiv);
    }
}

// Run a single script via Flask
async function runScript(stepId, scriptName, successMessage, parameters = null) {
    updateStep(stepId, 'running', 'Processing...');
    
    const bodyObj = {
        script: scriptName,
        source: source,
        destination: destination,
        vmname: vmname
    };
    // Add parameter only if it exists
    if (parameters) {
        bodyObj.extraValue = parameters;
    }
    const body = JSON.stringify(bodyObj);  
    try {     
            const response = await fetch('http://localhost:5000/api/run-script', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: body 
        });
        const result = await response.json();
        
        if (result.success) {
            updateStep(stepId, 'completed',  result.output);
            return true;
        } else {
            updateStep(stepId, 'error', 'Script failed', {
                type: 'error',
                message: result.error
            });
            return false;
        }
    } catch (error) {
        updateStep(stepId, 'error', error.message, {
            type: 'error',
            message: error.message
        });
        return false;
    }
}
// successMessage ||
//store the output of these scripts
const results = []; // store all outputs
    
// Run all migration steps
async function runMigration() {
    const steps = [
        { id: 'step1', script: 'fetch_vm.py', message: 'VM found successfully!' },  
        { id: 'step2', script: 'stop_vm.py', message: 'VM stopped successfully' },
        { id: 'step3', script: 'download_vm.py', message: 'Download completed' },
        { id: 'step4', script: 'transform_vm.py', message: 'Format conversion completed' },
        { id: 'step5', script: 'create_network.py', message: 'Network resources created' },
        { id: 'step6', script: 'upload_image.py', message: 'Upload completed successfully' },
        { id: 'step7', script: 'start_vm.py', message: 'VM is now running!' }
    ];
    
    for (const step of steps) {
        const success = await runScript(step.id, step.script, step.message);
        
        if (!success) {
            return; // Stop on error
        }
        
        await new Promise(resolve => setTimeout(resolve, 500)); // Small delay between steps
    }
    
    // Show success banner
    setTimeout(() => {
        document.getElementById('success-banner').classList.add('show');
    }, 500);
}

// Start migration when page loads
window.addEventListener('load', runMigration);
</script>
</body>
</html>
